(function(define,_win){define(["JC.BaseMVC"],function(){function DragSelect(e){e&&(e=$(e));if(JC.BaseMVC.getInstance(e,DragSelect))return JC.BaseMVC.getInstance(e,DragSelect);JC.BaseMVC.getInstance(e,DragSelect,this),this._model=new DragSelect.Model(e),this._view=new DragSelect.View(this._model),this._init(),JC.log(DragSelect.Model._instanceName,"all inited",(new Date).getTime())}function intersectRect(e,t){return!(t.x>e.x+e.width||t.x+t.width<e.x||t.y>e.y+e.height||t.y+t.height<e.y)}function pointToRect(e,t){var n={x:0,y:0,width:0,height:0};return e&&t&&(e.x<t.x?(n.x=e.x,n.width=t.x-e.x):(n.x=t.x,n.width=e.x-t.x),e.y<t.y?(n.y=e.y,n.height=t.y-e.y):(n.y=t.y,n.height=e.y-t.y),n.left=n.x,n.top=n.y),n}function selectorToRectangle(e){e=$(e);var t=e.offset(),n=e.prop("offsetWidth"),r=e.prop("offsetHeight");return{x:t.left,y:t.top,width:n,height:r}}var _jdoc=$(document),_jwin=$(window);return JC.DragSelect=DragSelect,DragSelect.init=function(e){var t=[];return e=$(e||document),e.length&&(e.hasClass("js_compDragSelect")?t.push(new DragSelect(e)):e.find("div.js_compDragSelect").each(function(){t.push(new DragSelect(this))})),t},DragSelect.RECT=function(){if(!DragSelect._RECT||!DragSelect._RECT.length)DragSelect._RECT=$(DragSelect.RECT_TPL),DragSelect._RECT.appendTo(document.body);return DragSelect._RECT},DragSelect.RECT_TPL='<div class="js_compDragSelect_rect" style="display:none;position:absolute;left: -9999px;"></div>',DragSelect.DEFAULT_MOUSEUP=function(e){var t=DragSelect.DRAG_DATA();if(!t)return;var n=t.ins;n.trigger("SELECT_DONE",[n._model.offset(e)])},DragSelect.DEFAULT_MOUSEMOVE=function(e){var t=DragSelect.DRAG_DATA();if(!t)return;var n=t.ins,r=n._model.offset(e);n._view.updateRect(r),n.trigger("SELECT_MOVE",[r])},DragSelect.DEFAULT_SELECT_EVENT=function(){return!1},DragSelect.DRAG_DATA=function(e){return typeof e!="undefined"&&(DragSelect._DRAG_DATA=e),DragSelect._DRAG_DATA},DragSelect.MIN_RECT={width:20,height:20},JC.BaseMVC.build(DragSelect),JC.f.extendObject(DragSelect.prototype,{_beforeInit:function(){},_initHanlderEvent:function(){var e=this,t;if(!e._model.config()){JC.log("JC.DragSelect config data not found!");return}e.on("inited",function(){t=e._model.delegateItems();if(!t.length)return;e.selector().delegate(t.join(","),"click",function(e){}),$.each(t,function(t,n){e.selector().delegate(n,"mousedown",function(t){var r=$(this);e.trigger("SELECT_START",[r,t,n])})})}),e.on("SELECT_START",function(t,n,r,i){var s;e.trigger("CLEAR_EVENT"),e.trigger("REMOVE_ALL_REALTIME_EFFECT"),s=e._model.initDragData(n,i);if(!s)return;s.ins=e,s.downPoint=e._model.offset(r),e._view.showRect(),e.trigger("BIND_EVENT")}),e.on("BIND_EVENT",function(t){_jdoc.on("mousemove",DragSelect.DEFAULT_MOUSEMOVE),_jdoc.on("mouseup",DragSelect.DEFAULT_MOUSEUP),!e._model.enableTextSelectable()&&_jdoc.on("selectstart",DragSelect.DEFAULT_SELECT_EVENT)}),e.on("CLEAR_EVENT",function(t){_jdoc.off("mousemove",DragSelect.DEFAULT_MOUSEMOVE),_jdoc.off("mouseup",DragSelect.DEFAULT_MOUSEUP),_jdoc.off("selectstart",DragSelect.DEFAULT_SELECT_EVENT),e._model.realtimeEffect()&&e.trigger("REMOVE_ALL_REALTIME_EFFECT"),e.trigger("CLEAR_DATA")}),e.on("SELECT_DONE",function(t,n){e._view.updateRect(n);var r=selectorToRectangle(DragSelect.RECT());e._model.rectIsOutsize(r)||e.trigger("PROCESSS_SELECT",[r,DragSelect.DRAG_DATA()]),e._view.hideRect(),e.trigger("CLEAR_EVENT")}),e.on("PROCESSS_SELECT",function(t,n,r){if(!DragSelect.RECT().is(":visible"))return;var i=e._model.getSelectItems(n,e._model.items(r.type));if(!i.length)return;r.data&&($.each(i,function(e,t){r.data.addClass&&t.addClass(r.data.addClass),r.data.removeClass&&t.removeClass(r.data.removeClass)}),r.data.callback&&r.data.callback.call(e,i,r.type)),e._model.commonCallback()&&e._model.commonCallback().call(e,i,r.type)}),e.on("SELECT_MOVE",function(t,n){e._model.realtimeEffect()&&e.trigger("REALTIME_EFFECT",[n])}),e.on("REALTIME_EFFECT",function(t,n){if(!DragSelect.RECT().is(":visible"))return;if(!e._model.realtimeClass(DragSelect.DRAG_DATA().data))return;var r=selectorToRectangle(DragSelect.RECT()),i=DragSelect.DRAG_DATA(),s=e._model.realtimeClass(DragSelect.DRAG_DATA().data);e.trigger("REMOVE_REALTIME_EFFECT",s);if(e._model.rectIsOutsize(r)){e._model.preRealtimeItems([]);return}var o=e._model.getSelectItems(r,e._model.items(i.type));$.each(o,function(e,t){t.addClass(s)}),e._model.preRealtimeItems(o)}),e.on("REMOVE_REALTIME_EFFECT",function(t,n,r){r=r||e._model.preRealtimeItems(),r&&n&&$.each(r,function(e,t){t.removeClass(n)})}),e.on("REMOVE_ALL_REALTIME_EFFECT",function(){e._model.realtimeClass()&&e._model.allItems().removeClass(e._model.realtimeClass()),$.each(e._model.config(),function(t,n){n.data&&n.data.realtimeClass&&e._model.items(t).removeClass(_items.data.realtimeClass)})}),e.on("CLEAR_DATA",function(e){DragSelect.DRAG_DATA(null)})},clearCache:function(){this.trigger("CLEAR_DATA")},_inited:function(){this.trigger("inited")}}),DragSelect.Model._instanceName="JCDragSelect",DragSelect.Model.UNI_COUNT=1,DragSelect.Model.BEFORE_FIND_PREFIX="beforeSelected",JC.f.extendObject(DragSelect.Model.prototype,{init:function(){this._itemsCache={}},enableTextSelectable:function(){return this.boolProp("cdsEnableTextSelectable")},realtimeClass:function(e){var t=this.config().realtimeClass||this.attrProp("cdsRealtimeClass");return e&&e.realtimeClass&&(t=e.realtimeClass),t||""},items:function(e){var t;return!t&&(t=this.selector().find(e)),t},allItems:function(){var e;return!e&&(e=this.selector().find(this.delegateItems().join(","))),e},enableCache:function(){return this.boolProp("cdsEnableCache")},preRealtimeItems:function(e){return typeof e!="undefined"&&(this._preRealtimeItems=e),this._preRealtimeItems},realtimeEffect:function(){return this.boolProp("cdsRealtimeEffect")},getSelectItems:function(e,t){var n=[];return $.each(t,function(t,r){r=$(r);var i=selectorToRectangle(r);intersectRect(e,i)&&n.push(r)}),n},commonCallback:function(){var e=this.config().commonCallback||this.callbackProp("cdsCommonCallback");return e},initDragData:function(e,t){var n=this,r=n.config().items[t];if(!r)return;return DragSelect.DRAG_DATA({type:t,data:r})},config:function(){return this._config||(this._config=eval("("+JC.f.scriptContent(this.selectorProp("cdsConfig"))+")")),this._config},delegateItems:function(){var e=[];return $.each(this.config().items,function(t,n){e.push(t)}),e},offset:function(e){var t={x:e.pageX,y:e.pageY};return t},checkMinRect:function(){},rectMinWidth:function(){return this.intProp("cdsRectMinWidth")},rectMinHeight:function(){return this.intProp("cdsRectMinHeight")},rectMinSize:function(){var e=this;return{width:e.rectMinWidth()||DragSelect.MIN_RECT.width,height:e.rectMinHeight()||DragSelect.MIN_RECT.height}},rectIsOutsize:function(e){var t=this,n,r=t.rectMinSize();return r.width>e.width&&r.height>e.height&&(n=!0),n}}),JC.f.extendObject(DragSelect.View.prototype,{init:function(){},showRect:function(){DragSelect.RECT().css({left:"-9999px"}).show()},updateRect:function(e){if(!DragSelect.DRAG_DATA()||!DragSelect.RECT().is(":visible"))return;var t=this,n=DragSelect.DRAG_DATA().downPoint,r=DragSelect.RECT(),i;if(!n)return;i=pointToRect(n,e),r.css(i)},hideRect:function(){var e=this;DragSelect.RECT().hide()}}),_jdoc.ready(function(){DragSelect.autoInit&&DragSelect.init()}),JC.DragSelect})})(typeof define=="function"&&define.amd?define:function(e,t,n){typeof e=="function"&&(n=e),typeof t=="function"&&(n=t),n&&n()},window);